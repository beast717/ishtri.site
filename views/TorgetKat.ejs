<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-http-backend/i18nextHttpBackend.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector/i18nextBrowserLanguageDetector.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universe of Products</title>
    <style>   

h1 {
    text-align: center;
    margin-bottom: 20px;
}

.productsContainer {
    margin-top: -27px;
    padding: 20px;
    flex: 1;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
}

.product {
    font-family: Arial, Helvetica, sans-serifx;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background-color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 15px;
}

.product:hover {
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
}

.product img {
    max-width: 300px;
    height: auto;
    border-radius: 5px;
}

.product h3 {
    margin: 0;
}

.no-products {
    text-align: center;
    font-size: 18px;
    margin-top: 20px;
}

.filter-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-family: 'Arial', sans-serif;
}

.filter-container label {
    font-size: 13px;
    color: #333;
    font-weight: bold;
}

#priceFilter, #dateFilter, #subCategoryFilter {
    padding: 7px;
    font-size: 13px;
    border-radius: 4px;
    background-color: #f9f9f9;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.page-container {
    display: flex;
    gap: 20px;
    padding: 20px;
}

.side-panel {
font-family: Arial, Helvetica, sans-serif;
width: 250px;
background-color: #f9f9f9;
border: 1px solid #ddd;
border-radius: 8px;
padding: 15px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
flex-shrink: 0;
}

.side-panel h3 {
margin-bottom: 15px;
font-size: 18px;
color: #333;
text-align: center;
}

.country-list, .car-brand-list {
list-style: none;
padding: 0;
margin: 0;
}


.country-list li, .car-brand-list li {
display: flex;
flex-direction: column;
align-items: flex-start;
margin-bottom: 10px;
}

.country-list li > div {
display: flex;
flex-direction: row; /* Align checkbox and label horizontally */
align-items: center; /* Vertically center the checkbox and label */
gap: 10px; /* Add spacing between checkbox and label */
}

.car-brand-list li > div {
display: flex;
flex-direction: row; /* Align checkbox and label horizontally */
align-items: center; /* Vertically center the checkbox and label */
gap: 10px; /* Add spacing between checkbox and label */
}


.country-list input[type="checkbox"], .car-brand-list input[type="checkbox"] {
margin-right: 10px;
cursor: pointer;
}

.country-list label, .car-brand-list label {
font-size: 16px;
color: #555;
cursor: pointer;
}

.country-list label:hover, .car-brand-list label:hover {
color: #007bff;
}

.sold-label {
color: #ffffff;
background-color: #ff5722;
padding: 3px 6px;
border-radius: 4px;
font-size: 14px;
font-weight: bold;
margin-left: 5px;
display: inline-block;
}


/* City List Styling (Nested) */
.city-list {
list-style: none;
padding-left: 20; /* Reduced padding to align cities properly */
margin: 5px 0 0 0; /* Adjusted margin to remove any left offset */
display: none; /* Hidden by default */
}

.city-list li {
display: flex;
flex-direction: row;
align-items: center; /* Align checkbox and label vertically */
margin-bottom: 5px; /* Add spacing between cities */
}

.city-list input[type="checkbox"] {
margin-right: 10px;
cursor: pointer;
}

.city-list label {
font-size: 14px;
color: #777;
cursor: pointer;
}

.city-list label:hover {
color: #007bff;
}

.load-more-btn {
display: block;
margin: 30px auto;
padding: 12px 24px;
background: #007bff;
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 16px;
}

.load-more-btn:hover {
background: #0056b3;
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.load-more-btn:disabled {
background: #cccccc;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(255, 255, 255, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.reset-filters-btn {
position: fixed;
bottom: 30px;
right: 30px;
padding: 12px 24px;
background: #dc3545;
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
z-index: 1000;
display: flex;
align-items: center;
gap: 8px;
}

.reset-filters-btn:hover {
background: #bb2d3b;
transform: translateY(-2px);
box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
}

.reset-filters-btn:active {
transform: translateY(0);
}
        
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    <script src="/shared.js"></script>

    <div class="filter-container" style="margin-bottom: 20px;">
        <label for="priceFilter" data-i18n="filter.sorter_etter">Sorter etter:</label>
        <select id="priceFilter" onchange="applyFilters()">
            <option value="asc" data-i18n="filter.lavest_pris">Lavest Pris</option>
            <option value="desc" data-i18n="filter.høyest_pris">Høyest Pris</option>
            <option value="" data-i18n="filter.alle">alle</option>
        </select>
        <label for="dateFilter" data-i18n="filter.utgitt">Utgitt:</label>
        <select id="dateFilter" onchange="applyFilters()">
            <option value="" data-i18n="filter.alle">alle</option>
            <option value="desc" data-i18n="filter.nylige">Nylige</option>
            <option value="asc" data-i18n="filter.eldre">Eldre</option>
        </select>
        <div id="subcategoryFilterContainer" style="display: none;">
            <label for="subCategoryFilter" data-i18n="form.category">Kategori:</label>
            <select id="subCategoryFilter" onchange="applyFilters()">
                <option value="" data-i18n="filter.alle">Alle</option>
                <option value="Klær" data-i18n="subkategori.klær">Klær</option>
                <option value="Elektronikk" data-i18n="subkategori.elektronikk">Elektronikk</option>
                <option value="Hvitvarer" data-i18n="subkategori.hvitvarer">Hvitvarer</option>
                <option value="Møbler" data-i18n="subkategori.møbler">Møbler</option>
                <option value="Annet" data-i18n="subkategori.annet">Annet</option>
            </select>
            <button onclick="resetFilters()" class="reset-filters-btn">
    ⟳ Reset Filters
</button>
        </div> 
    </div>  

    <div class="page-container">
        <div class="side-panel">
            <h3 data-i18n="filter.filter_land">Filter by Country</h3>
            <ul class="country-list">
                <ul class="country-list">
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="uae" value="United Arab Emirates">
            <label for="uae">United Arab Emirates</label>
        </div>
        <ul class="city-list" id="uae-cities" style="display: none;">
            <!-- Cities for UAE will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="saudi" value="Saudi Arabia">
            <label for="saudi">Saudi Arabia</label>
        </div>
        <ul class="city-list" id="saudi-cities" style="display: none;">
            <!-- Cities for Saudi Arabia will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="egypt" value="Egypt">
            <label for="egypt">Egypt</label>
        </div>
        <ul class="city-list" id="egypt-cities" style="display: none;">
            <!-- Cities for Egypt will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="jordan" value="Jordan">
            <label for="jordan">Jordan</label>
        </div>
        <ul class="city-list" id="jordan-cities" style="display: none;">
            <!-- Cities for Jordan will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="qatar" value="Qatar">
            <label for="qatar">Qatar</label>
        </div>
        <ul class="city-list" id="qatar-cities" style="display: none;">
            <!-- Cities for Qatar will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="oman" value="Oman">
            <label for="oman">Oman</label>
        </div>
        <ul class="city-list" id="oman-cities" style="display: none;">
            <!-- Cities for Oman will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="kuwait" value="Kuwait">
            <label for="kuwait">Kuwait</label>
        </div>
        <ul class="city-list" id="kuwait-cities" style="display: none;">
            <!-- Cities for Kuwait will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="bahrain" value="Bahrain">
            <label for="bahrain">Bahrain</label>
        </div>
        <ul class="city-list" id="bahrain-cities" style="display: none;">
            <!-- Cities for Bahrain will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="iraq" value="Iraq">
            <label for="iraq">Iraq</label>
        </div>
        <ul class="city-list" id="iraq-cities" style="display: none;">
            <!-- Cities for Iraq will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="syria" value="Syria">
            <label for="syria">Syria</label>
        </div>
        <ul class="city-list" id="syria-cities" style="display: none;">
            <!-- Cities for Syria will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="lebanon" value="Lebanon">
            <label for="lebanon">Lebanon</label>
        </div>
        <ul class="city-list" id="lebanon-cities" style="display: none;">
            <!-- Cities for Lebanon will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="yemen" value="Yemen">
            <label for="yemen">Yemen</label>
        </div>
        <ul class="city-list" id="yemen-cities" style="display: none;">
            <!-- Cities for Yemen will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="libya" value="Libya">
            <label for="libya">Libya</label>
        </div>
        <ul class="city-list" id="libya-cities" style="display: none;">
            <!-- Cities for Libya will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="sudan" value="Sudan">
            <label for="sudan">Sudan</label>
        </div>
        <ul class="city-list" id="sudan-cities" style="display: none;">
            <!-- Cities for Sudan will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="morocco" value="Morocco">
            <label for="morocco">Morocco</label>
        </div>
        <ul class="city-list" id="morocco-cities" style="display: none;">
            <!-- Cities for Morocco will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="tunisia" value="Tunisia">
            <label for="tunisia">Tunisia</label>
        </div>
        <ul class="city-list" id="tunisia-cities" style="display: none;">
            <!-- Cities for Tunisia will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="algeria" value="Algeria">
            <label for="algeria">Algeria</label>
        </div>
        <ul class="city-list" id="algeria-cities" style="display: none;">
            <!-- Cities for Algeria will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="palestine" value="Palestine">
            <label for="palestine">Palestine</label>
        </div>
        <ul class="city-list" id="palestine-cities" style="display: none;">
            <!-- Cities for Palestine will be dynamically added here -->
        </ul>
    </li>
    <li>
        <div> <!-- Nested flex container for checkbox and label -->
            <input type="checkbox" id="mauritania" value="Mauritania">
            <label for="mauritania">Mauritania</label>
        </div>
        <ul class="city-list" id="mauritania-cities" style="display: none;">
            <!-- Cities for Mauritania will be dynamically added here -->
        </ul>
    </li>
</ul>
    
    <h3 id="filterCar">Filter Car</h3>
    <ul class="car-brand-list" id="kjørr">
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="toyota" value="Toyota">
                <label for="toyota">Toyota</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="ford" value="Ford">
                <label for="ford">Ford</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="volkswagen" value="Volkswagen">
                <label for="volkswagen">Volkswagen</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="bmw" value="BMW">
                <label for="bmw">BMW</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mercedes" value="Mercedes-Benz">
                <label for="mercedes">Mercedes-Benz</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="audi" value="Audi">
                <label for="audi">Audi</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="chevrolet" value="Chevrolet">
                <label for="chevrolet">Chevrolet</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="honda" value="Honda">
                <label for="honda">Honda</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="hyundai" value="Hyundai">
                <label for="hyundai">Hyundai</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="nissan" value="Nissan">
                <label for="nissan">Nissan</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="tesla" value="Tesla">
                <label for="tesla">Tesla</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="jeep" value="Jeep">
                <label for="jeep">Jeep</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mazda" value="Mazda">
                <label for="mazda">Mazda</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="kia" value="Kia">
                <label for="kia">Kia</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="subaru" value="Subaru">
                <label for="subaru">Subaru</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="lexus" value="Lexus">
                <label for="lexus">Lexus</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="volvo" value="Volvo">
                <label for="volvo">Volvo</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="jaguar" value="Jaguar">
                <label for="jaguar">Jaguar</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="porsche" value="Porsche">
                <label for="porsche">Porsche</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="landrover" value="Land Rover">
                <label for="landrover">Land Rover</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mitsubishi" value="Mitsubishi">
                <label for="mitsubishi">Mitsubishi</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="fiat" value="Fiat">
                <label for="fiat">Fiat</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="peugeot" value="Peugeot">
                <label for="peugeot">Peugeot</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="renault" value="Renault">
                <label for="renault">Renault</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="citroen" value="Citroën">
                <label for="citroen">Citroën</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="skoda" value="Škoda">
                <label for="skoda">Škoda</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="infiniti" value="Infiniti">
                <label for="infiniti">Infiniti</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="acura" value="Acura">
                <label for="acura">Acura</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="alfa-romeo" value="Alfa Romeo">
                <label for="alfa-romeo">Alfa Romeo</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="aston-martin" value="Aston Martin">
                <label for="aston-martin">Aston Martin</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="bentley" value="Bentley">
                <label for="bentley">Bentley</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="bugatti" value="Bugatti">
                <label for="bugatti">Bugatti</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="cadillac" value="Cadillac">
                <label for="cadillac">Cadillac</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="chrysler" value="Chrysler">
                <label for="chrysler">Chrysler</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="dodge" value="Dodge">
                <label for="dodge">Dodge</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="ferrari" value="Ferrari">
                <label for="ferrari">Ferrari</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="gmc" value="GMC">
                <label for="gmc">GMC</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="hummer" value="Hummer">
                <label for="hummer">Hummer</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="lamborghini" value="Lamborghini">
                <label for="lamborghini">Lamborghini</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="lincoln" value="Lincoln">
                <label for="lincoln">Lincoln</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="maserati" value="Maserati">
                <label for="maserati">Maserati</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mcLaren" value="McLaren">
                <label for="mcLaren">McLaren</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mini" value="Mini">
                <label for="mini">Mini</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="rolls-royce" value="Rolls-Royce">
                <label for="rolls-royce">Rolls-Royce</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="saab" value="Saab">
                <label for="saab">Saab</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="scion" value="Scion">
                <label for="scion">Scion</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="seat" value="SEAT">
                <label for="seat">SEAT</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="smart" value="Smart">
                <label for="smart">Smart</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="suzuki" value="Suzuki">
                <label for="suzuki">Suzuki</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="tata" value="Tata">
                <label for="tata">Tata</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="pagani" value="Pagani">
                <label for="pagani">Pagani</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="koenigsegg" value="Koenigsegg">
                <label for="koenigsegg">Koenigsegg</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="genesis" value="Genesis">
                <label for="genesis">Genesis</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mg" value="MG">
                <label for="mg">MG</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="opel" value="Opel">
                <label for="opel">Opel</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="daewoo" value="Daewoo">
                <label for="daewoo">Daewoo</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="isuzu" value="Isuzu">
                <label for="isuzu">Isuzu</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="geely" value="Geely">
                <label for="geely">Geely</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="proton" value="Proton">
                <label for="proton">Proton</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="perodua" value="Perodua">
                <label for="perodua">Perodua</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="chery" value="Chery">
                <label for="chery">Chery</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="byd" value="BYD">
                <label for="byd">BYD</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="great-wall" value="Great Wall">
                <label for="great-wall">Great Wall</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="mahindra" value="Mahindra">
                <label for="mahindra">Mahindra</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="ssangyong" value="SsangYong">
                <label for="ssangyong">SsangYong</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="lucid" value="Lucid">
                <label for="lucid">Lucid</label>
            </div>
        </li>
        <li>
            <div> <!-- Wrapper for checkbox and label -->
                <input type="checkbox" id="rivian" value="Rivian">
                <label for="rivian">Rivian</label>
            </div>
        </li>
    </ul>
</div>

        <div class="productsContainer" id="productsContainer">
            <p>Loading products...</p>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

    <script>
    (function () {
        console.log("Initializing TorgetKat page...");
        let filterTimeout;
        const DEBOUNCE_DELAY = 300; // ms


        // Pagination variables
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const limit = 20;

        // Current filter state
        let currentFilters = {
            priceOrder: '',
            selectedCountries: [],
            dateOrder: '',
            subCategory: '',
            selectedCarBrands: [],
            selectedCities: []
        };

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function fetchProducts(loadMore = false, cacheBuster = null) {
            if (isLoading || (!loadMore && !hasMore)) return;
            
            showLoading();
            isLoading = true;

            const offset = (currentPage - 1) * limit;
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category') || 'default';

            // Build API URL with current filters
            let apiUrl = `/api/products?category=${category}&limit=${limit}&offset=${offset}`;
                    // Add cache busting
            if (cacheBuster) {
                apiUrl += `&_=${cacheBuster}`;
            }
            if (currentFilters.subCategory) apiUrl += `&subCategory=${currentFilters.subCategory}`;
            if (currentFilters.priceOrder) apiUrl += `&sortPrice=${currentFilters.priceOrder}`;
            if (currentFilters.dateOrder) apiUrl += `&sortDate=${currentFilters.dateOrder}`;
            if (currentFilters.selectedCountries.length) apiUrl += `&countries=${currentFilters.selectedCountries.join(',')}`;
            if (currentFilters.selectedCarBrands.length) apiUrl += `&carBrand=${currentFilters.selectedCarBrands.join(',')}`;
            if (currentFilters.selectedCities.length) apiUrl += `&cities=${currentFilters.selectedCities.join(',')}`;

            // Show loading state
            const container = document.getElementById('productsContainer');
            const loadButton = document.getElementById('loadMoreButton');
            if (!loadMore) container.innerHTML = '<p>Loading products...</p>';
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.textContent = 'Loading...';
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    hasMore = (currentPage * limit) < data.total;
                    displayProducts(data.products, loadMore);
                    currentPage++;
                    isLoading = false;

                    // Update load more button
                    if (loadButton) {
                        loadButton.disabled = false;
                        loadButton.textContent = 'Load More';
                        if (!hasMore) loadButton.remove();
                    } else if (hasMore) {
                        addLoadMoreButton();
                    }
                     hideLoading();
                })
                .catch(error => {
                    console.error("Error fetching products:", error);
                    isLoading = false;
                    const container = document.getElementById('productsContainer');
                    container.innerHTML = `
                        <div class="error-message">
                            <p>Error loading products. Please try again.</p>
                            <button onclick="fetchProducts()">Retry</button>
                        </div>
                    `;
                    hideLoading();
                    if (loadButton) {
                        loadButton.disabled = false;
                        loadButton.textContent = 'Load More';
                    }
                });
        }

        function resetFilters() {
            console.log('[DEBUG] Resetting filters...');
            
            // 1. Reset UI elements
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.getElementById('priceFilter').value = 'asc';
            document.getElementById('dateFilter').value = '';
            document.getElementById('subCategoryFilter').value = '';
            
            // 2. Clear city lists
            document.querySelectorAll('.city-list').forEach(list => {
                list.innerHTML = '';
                list.style.display = 'none';
            });

            // 3. Reset internal state
            currentFilters = {
                priceOrder: 'asc',
                dateOrder: '',
                subCategory: '',
                selectedCountries: [],
                selectedCarBrands: [],
                selectedCities: []
            };

            // 4. Reset pagination
            currentPage = 1;
            hasMore = true;
            isLoading = false; 

            // 5. Clear container and force fresh load
            const container = document.getElementById('productsContainer');
            container.innerHTML = '<p>Loading products...</p>';
            
            // 6. Fetch with cache busting
            fetchProducts(false, Date.now());
        };

        window.resetFilters = resetFilters;
        window.fetchProducts = fetchProducts;

        function displayProducts(products, append = false) {
            const container = document.getElementById('productsContainer');
            if (!container) return;

            if (!append) {
                container.innerHTML = '';
                currentPage = 1;
            }

            if (products.length === 0 && !append) {
                container.innerHTML = '<p class="no-products">No products found for this category.</p>';
                return;
            }

            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.className = 'product';

                const images = product.Images ? product.Images.split(',') : [];
                const firstImage = images.length > 0 ? `/uploads/${images[0].trim()}` : '/uploads/default-placeholder.png';

                productDiv.innerHTML = `
                    <img src="${firstImage}" alt="${product.ProductName}">
                    <i class="fas fa-heart favorite-icon" data-product-id="${product.ProductdID}"></i>
                    <div>
                        <h3>
                            ${product.ProductName} 
                            ${product.Sold ? `<span class="sold-label">(Sold)</span>` : ''}
                        </h3>
                        <p><strong>Price:</strong> ${product.Price} $</p>
                        <p><strong>Location:</strong> ${product.Location}</p>
                    </div>
                `;

                productDiv.addEventListener('click', () => {
                    const favoriteIcon = productDiv.querySelector('.favorite-icon');
                    const isFavorited = favoriteIcon.classList.contains('favorited');
                    window.location.href = `/productDetails?productdID=${product.ProductdID}&favorited=${isFavorited}`;
                });

                container.appendChild(productDiv);
            });

            initializeFavorites();

            document.querySelectorAll('.favorite-icon').forEach(icon => {
            icon.addEventListener('click', (e) => {
                e.stopPropagation();
                const productdID = icon.getAttribute('data-product-id');
                const isFavorited = icon.classList.contains('favorited');

                if (isFavorited) {
                    fetch('/api/unfavorite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productdID }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        icon.classList.remove('favorited');
                        icon.style.color = '#ccc';
                    })
                    .catch(error => console.error("Error unfavoriting product:", error));
                } else {
                    fetch('/api/favorite', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ productdID }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        icon.classList.add('favorited');
                        icon.style.color = '#ff4757';
                    })
                    .catch(error => console.error("Error favoriting product:", error));
                }
            });
        });
    }

        function addLoadMoreButton() {
            const existingButton = document.getElementById('loadMoreButton');
            if (existingButton) return;

            const button = document.createElement('button');
            button.id = 'loadMoreButton';
            button.className = 'load-more-btn';
            button.textContent = 'Load More';
            button.addEventListener('click', () => fetchProducts(true));
            
            const container = document.getElementById('productsContainer');
            container.appendChild(button);
        }

        function applyFilters() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                // Update current filters
                currentFilters = {
                    priceOrder: document.getElementById('priceFilter').value,
                    dateOrder: document.getElementById('dateFilter').value,
                    subCategory: document.getElementById('subCategoryFilter')?.value || '',
                    selectedCountries: Array.from(document.querySelectorAll('.country-list input[type="checkbox"]:checked'))
                        .map(checkbox => checkbox.value),
                    selectedCarBrands: Array.from(document.querySelectorAll('.car-brand-list input[type="checkbox"]:checked'))
                        .map(checkbox => checkbox.value),
                    selectedCities: Array.from(document.querySelectorAll('.city-list input[type="checkbox"]:checked'))
                        .map(checkbox => checkbox.value)
                };

                // Reset pagination
                currentPage = 1;
                hasMore = true;
            // Clear existing products
                document.getElementById('productsContainer').innerHTML = '<p>Loading products...</p>';
                
                fetchProducts();
            }, DEBOUNCE_DELAY);
        }

    document.getElementById('dateFilter').addEventListener('change', () => {
    document.getElementById('priceFilter').value = '';
    applyFilters();
});
    document.getElementById('priceFilter').addEventListener('change', () => {
    document.getElementById('dateFilter').value = '';
    applyFilters();
});

function handleCategoryVisibility() {
    const urlParams = new URLSearchParams(window.location.search);
    const category = urlParams.get('category') || 'default';
    const subcategoryContainer = document.getElementById('subcategoryFilterContainer');
    const carBrandSection = document.getElementById('kjørr');
    const carBrandLabel = document.getElementById('filterCar');

    // Toggle subcategory filter
    if (subcategoryContainer) {
        subcategoryContainer.style.display = category === 'Torget' ? 'block' : 'none';
    }

    // Toggle car brand filter
    if (carBrandSection && carBrandLabel) {
        const shouldShow = category === 'Bil';
        carBrandSection.style.display = shouldShow ? 'block' : 'none';
        carBrandLabel.style.display = shouldShow ? 'block' : 'none';
    }
}

        function initializeFilters() {
            // Price and Date filters
            document.getElementById('priceFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            
            // Subcategory filter
            const subCategoryFilter = document.getElementById('subCategoryFilter');
            if (subCategoryFilter) {
                subCategoryFilter.addEventListener('change', applyFilters);
            }

            // Country checkboxes
            document.querySelectorAll('.country-list input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const cityList = document.getElementById(`${this.id}-cities`);
                
                if (this.checked) {
                    fetch(`/api/cities?country=${this.value}`)
                        .then(response => response.json())
                        .then(cities => {
                            cityList.innerHTML = cities.map(city => `
                                <li>
                                    <input type="checkbox" id="${city.cityName}" 
                                           value="${city.cityName}"
                                           ${currentFilters.selectedCities.includes(city.cityName) ? 'checked' : ''}>
                                    <label for="${city.cityName}">${city.cityName}</label>
                                </li>
                            `).join('');
                            
                            cityList.querySelectorAll('input').forEach(cityCheckbox => {
                                cityCheckbox.addEventListener('change', applyFilters);
                            });
                        })
                        .catch(error => {
                            console.error("Error fetching cities:", error);
                            cityList.innerHTML = '<li>Error loading cities</li>';
                        });
                } else {
                    // Clear city selections when country is deselected
                    currentFilters.selectedCities = currentFilters.selectedCities.filter(
                        city => !cityList.querySelectorAll('input').values.includes(city)
                    );
                    cityList.innerHTML = '';
                }
                
                cityList.style.display = this.checked ? 'block' : 'none';
                applyFilters();
            });
        });


            // Car brand checkboxes
            document.querySelectorAll('.car-brand-list input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }

        function initializeFavorites() {
            fetch('/api/favorites')
                .then(response => response.json())
                .then(favorites => {
                    document.querySelectorAll('.favorite-icon').forEach(icon => {
                        const productdID = icon.getAttribute('data-product-id');
                        const isFavorited = favorites.some(product => product.ProductdID === Number(productdID));
                        icon.classList.toggle('favorited', isFavorited);
                        icon.style.color = isFavorited ? '#ff4757' : '#ccc';
                    });
                })
                .catch(error => console.error("Error checking favorites:", error));
        }

        window.onload = function () {
            fetchProducts();
            checkUnreadMessages();
            initializeFilters();
            initializeFavorites();
            applyFilters();
            handleCategoryVisibility();
            checkUnreadMessages();
        };
    })();
</script>
</body>
</html>