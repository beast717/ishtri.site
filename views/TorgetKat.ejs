<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universe of Products</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/toast.js" defer></script>
    <script src="/js/skeleton.js" defer></script>
    <script src="/js/backToTop.js" defer></script>
    <script src="/js/lazyLoad.js" defer></script>
    
    <style>   

h1 {
    text-align: center;
    margin-bottom: 20px;
}

.productsContainer {
    margin-top: -27px;  
    padding: 20px;
    flex: 1;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive grid */
}

.product {
    font-family: Arial, Helvetica, sans-serifx;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background-color: white;
    cursor: pointer;
    display: flex;
    align-items: flex-start;
    gap: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.product:hover {
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.product img {
    max-width: 300px;
    height: auto;
    border-radius: 5px;
    object-fit: cover;
}

.product h3 {
    margin: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 1.2em;
    color: #333;
}

.product p {
    margin: 8px 0;
    color: #666;
    font-size: 0.95em;
}

.product strong {
    color: #444;
}

.favorite-icon {
    cursor: pointer;
    color: #ccc;
    transition: color 0.3s ease, transform 0.2s ease;
    font-size: 1.2em;
    margin-left: 10px;
    background: none;
    border: none;
    padding: 0;
    outline: none;
    -webkit-tap-highlight-color: transparent;
}

.favorite-icon:hover {
    transform: scale(1.1);
}

.favorite-icon:focus {
    outline: none;
    box-shadow: none;
}

.favorite-icon.favorited {
    color: #ff4757;
}

.no-products {
    text-align: center;
    font-size: 18px;
    margin-top: 20px;
}

.filter-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    font-family: 'Arial', sans-serif;
}

.filter-container label {
    font-size: 13px;
    color: #333;
    font-weight: bold;
}

#priceFilter, #dateFilter, #subCategoryFilter {
    padding: 7px;
    font-size: 13px;
    border-radius: 4px;
    background-color: #f9f9f9;
    transition: background-color 0.3s ease, border-color 0.3s ease;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.page-container {
    display: flex;
    gap: 20px;
    padding: 20px;
}

.side-panel {
font-family: Arial, Helvetica, sans-serif;
width: 250px;
background-color: #f9f9f9;
border: 1px solid #ddd;
border-radius: 8px;
padding: 15px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
flex-shrink: 0;
}

.side-panel h3 {
margin-bottom: 15px;
font-size: 18px;
color: #333;
text-align: center;
}

.country-list, .car-brand-list {
list-style: none;
padding: 0;
margin: 0;
}


.country-list li, .car-brand-list li {
display: flex;
flex-direction: column;
align-items: flex-start;
margin-bottom: 10px;
}

.country-list li > div {
display: flex;
flex-direction: row; /* Align checkbox and label horizontally */
align-items: center; /* Vertically center the checkbox and label */
gap: 10px; /* Add spacing between checkbox and label */
}

.car-brand-list li > div {
display: flex;
flex-direction: row; /* Align checkbox and label horizontally */
align-items: center; /* Vertically center the checkbox and label */
gap: 10px; /* Add spacing between checkbox and label */
}


.country-list input[type="checkbox"], .car-brand-list input[type="checkbox"] {
margin-right: 10px;
cursor: pointer;
}

.country-list label, .car-brand-list label {
font-size: 16px;
color: #555;
cursor: pointer;
}

.country-list label:hover, .car-brand-list label:hover {
color: #007bff;
}

.sold-label {
color: #ffffff;
background-color: #ff5722;
padding: 3px 6px;
border-radius: 4px;
font-size: 14px;
font-weight: bold;
margin-left: 5px;
display: inline-block;
}


/* City List Styling (Nested) */
.city-list {
list-style: none;
padding-left: 20; /* Reduced padding to align cities properly */
margin: 5px 0 0 0; /* Adjusted margin to remove any left offset */
display: none; /* Hidden by default */
}

.city-list li {
display: flex;
flex-direction: row;
align-items: center; /* Align checkbox and label vertically */
margin-bottom: 5px; /* Add spacing between cities */
}

.city-list input[type="checkbox"] {
margin-right: 10px;
cursor: pointer;
}

.city-list label {
font-size: 14px;
color: #777;
cursor: pointer;
}

.city-list label:hover {
color: #007bff;
}

.load-more-btn {
    position: relative; 
    margin: 20px auto; 
    padding: 12px 24px;
    width: fit-content;
    max-width: 200px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: none;
}


.load-more-btn:hover {
  background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.load-more-btn:disabled {
background: #cccccc;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(255, 255, 255, 0.8);
display: none;
justify-content: center;
align-items: center;
z-index: 1000;
}

.reset-filters-btn {
position: fixed;
bottom: 30px;
right: 30px;
padding: 12px 24px;
background: #dc3545;
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
z-index: 1000;
display: flex;
align-items: center;
gap: 8px;
}

.reset-filters-btn:hover {
background: #bb2d3b;
transform: translateY(-2px);
box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
}

.reset-filters-btn:active {
transform: translateY(0);
}

.custom-title {
    color: #666;
    font-size: 1.2rem;
    font-weight: normal;
    margin-top: 5px;
}

.filter-section {
    margin: 15px 0;
    padding: 10px;
    border-top: 1px solid #eee;
}

.filter-section h4 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 14px;
}

.range-inputs {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.range-inputs input {
    width: 100%;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

select[multiple] {
    width: 100%;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    height: auto;
    min-height: 80px;
}

select[multiple] option {
    padding: 5px;
}

select[multiple] option:checked {
    background-color: #007bff;
    color: white;
}

.date-input input {
    width: 100%;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    margin-bottom: 10px;
}

/* Skeleton Loading Styles */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-image {
    width: 300px;
    height: 200px;
    border-radius: 5px;
}

.skeleton-text {
    height: 20px;
    margin: 10px 0;
    border-radius: 4px;
}

.skeleton-title {
    width: 70%;
}

.skeleton-price {
    width: 40%;
}

.skeleton-location {
    width: 60%;
}

/* Toast Notification Styles */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.toast {
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-bottom: 10px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

/* Back to Top Button Styles */
.back-to-top {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #007bff;
    color: white;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 1000;
}

.back-to-top.visible {
    opacity: 1;
    visibility: visible;
}

.back-to-top:hover {
    background: #0056b3;
    transform: translateY(-3px);
}

        
    </style>
</head>
<body>
    <%- include('partials/navbar') %>
    <script src="/shared.js"></script>

    <div class="filter-container" style="margin-bottom: 20px;">
        <label for="priceFilter" data-i18n="filter.sorter_etter">Sort By:</label>
        <select id="priceFilter" onchange="applyFilters()">
            <option value="asc" data-i18n="filter.lavest_pris">Lowest Price</option>
            <option value="desc" data-i18n="filter.høyest_pris">Highest Price</option>
            <option value="" data-i18n="filter.alle">All</option>
        </select>
        <label for="dateFilter" data-i18n="filter.utgitt">Date:</label>
        <select id="dateFilter" onchange="applyFilters()">
            <option value="" data-i18n="filter.alle">All</option>
            <option value="desc" data-i18n="filter.nylige">New</option>
            <option value="asc" data-i18n="filter.eldre">Old</option>
        </select>
        <div id="subcategoryFilterContainer" style="display: none;">
            <label for="subCategoryFilter" data-i18n="form.category">Categori:</label>
            <select id="subCategoryFilter" onchange="applyFilters()">
                <option value="" data-i18n="filter.alle">All</option>
                <option value="Klær" data-i18n="subkategori.klær">Clothes</option>
                <option value="Elektronikk" data-i18n="subkategori.elektronikk">Electronics</option>
                <option value="Hvitvarer" data-i18n="subkategori.hvitvarer">White Goods</option>
                <option value="Møbler" data-i18n="subkategori.møbler">Furniture</option>
                <option value="Annet" data-i18n="subkategori.annet">Else</option>
            </select>
        </div> 
    </div>  

    <!-- Move reset filters button outside of subcategoryFilterContainer -->
    <button onclick="resetFilters()" class="reset-filters-btn" id="resetFiltersBtn" style="display: none;">
        ⟳ Reset Filters
    </button>

    <div class="page-container">
        <div class="side-panel">
            <h3 data-i18n="filter.filter_land">Filter by Country</h3>
            <ul class="country-list">
                <!-- Countries will be populated here -->
            </ul>
    
            <h3 id="filterCar">Filter by Car</h3>
            <ul class="car-brand-list" id="carBrandList">
                <!-- Car brands will be populated here -->
            </ul>

            <!-- Add Car Specific Filters -->
            <div id="carSpecificFilters" style="display: none;">
                <!-- Year Range Filter -->
                <div class="filter-section">
                    <h4 data-i18n="filter.year_range">Year Range</h4>
                    <div class="range-inputs">
                        <input type="number" id="yearFrom" data-i18n="[placeholder]filter.from" placeholder="From" min="1900" max="2024">
                        <input type="number" id="yearTo" data-i18n="[placeholder]filter.to" placeholder="To" min="1900" max="2024">
                    </div>
                </div>

                <!-- Mileage Range Filter -->
                <div class="filter-section">
                    <h4 data-i18n="filter.mileage_range">Mileage (km)</h4>
                    <div class="range-inputs">
                        <input type="number" id="mileageFrom" data-i18n="[placeholder]filter.from" placeholder="From" min="0">
                        <input type="number" id="mileageTo" data-i18n="[placeholder]filter.to" placeholder="To">
                    </div>
                </div>

                <!-- Fuel Type Filter -->
                <div class="filter-section">
                    <h4 data-i18n="filter.fuel_type">Fuel Type</h4>
                    <select id="fuelTypeFilter" multiple>
                        <option value="Petrol" data-i18n="fuel.petrol">Petrol</option>
                        <option value="Diesel" data-i18n="fuel.diesel">Diesel</option>
                        <option value="Hybrid" data-i18n="fuel.hybrid">Hybrid</option>
                        <option value="Electric" data-i18n="fuel.electric">Electric</option>
                        <option value="Other" data-i18n="filter.other">Other</option>
                    </select>
                </div>

                <!-- Transmission Filter -->
                <div class="filter-section">
                    <h4>Transmission</h4>
                    <select id="transmissionFilter" multiple>
                        <option value="Manual">Manual</option>
                        <option value="Automatic">Automatic</option>
                    </select>
                </div>
            </div>

            <!-- Add Property Specific Filters -->
            <div id="propertySpecificFilters" style="display: none;">
                <!-- Property Type Filter -->
                <div class="filter-section">
                    <h4>Property Type</h4>
                    <select id="propertyTypeFilter" multiple>
                        <option value="Apartment">Apartment</option>
                        <option value="House">House</option>
                        <option value="Cabin">Cabin</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Commercial">Commercial</option>
                    </select>
                </div>

                <!-- Size Range Filter -->
                <div class="filter-section">
                    <h4>Size (m²)</h4>
                    <div class="range-inputs">
                        <input type="number" id="sizeFrom" placeholder="From" min="0">
                        <input type="number" id="sizeTo" placeholder="To">
                    </div>
                </div>

                <!-- Rooms Filter -->
                <div class="filter-section">
                    <h4>Number of Rooms</h4>
                    <div class="range-inputs">
                        <input type="number" id="roomsFrom" placeholder="From" min="0">
                        <input type="number" id="roomsTo" placeholder="To">
                    </div>
                </div>

                <!-- Bathrooms Filter -->
                <div class="filter-section">
                    <h4>Number of Bathrooms</h4>
                    <div class="range-inputs">
                        <input type="number" id="bathroomsFrom" placeholder="From" min="0">
                        <input type="number" id="bathroomsTo" placeholder="To">
                    </div>
                </div>

                <!-- Energy Class Filter -->
                <div class="filter-section">
                    <h4>Energy Class</h4>
                    <select id="energyClassFilter" multiple>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                    </select>
                </div>
            </div>

            <!-- Add Work Specific Filters -->
            <div id="workSpecificFilters" style="display: none;">
                <!-- Employment Type Filter -->
                <div class="filter-section">
                    <h4>Employment Type</h4>
                    <select id="employmentTypeFilter" multiple>
                        <option value="Full-time">Full-time</option>
                        <option value="Part-time">Part-time</option>
                        <option value="Contract">Contract</option>
                        <option value="Temporary">Temporary</option>
                        <option value="Internship">Internship</option>
                    </select>
                </div>

                <!-- Salary Range Filter -->
                <div class="filter-section">
                    <h4>Salary Range (NOK)</h4>
                    <div class="range-inputs">
                        <input type="number" id="salaryFrom" placeholder="From" min="0">
                        <input type="number" id="salaryTo" placeholder="To">
                    </div>
                </div>

                <!-- Application Deadline Filter -->
                <div class="filter-section">
                    <h4>Application Deadline</h4>
                    <div class="date-input">
                        <input type="date" id="deadlineDate">
                    </div>
                </div>
            </div>
        </div>

        <div class="productsContainer" id="productsContainer">
            <!-- Skeleton loading will be shown here -->
        </div>
    </div>


    <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("Initializing TorgetKat page...");
        
        // Function to update all translatable content
        function updatePageContent() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (!key) return;

                try {
                    const translation = i18next.t(key);
                    if (element.tagName === 'INPUT') {
                        if (element.type === 'text' || element.type === 'placeholder') {
                            element.placeholder = translation;
                        }
                    } else if (element.tagName === 'OPTION') {
                        element.textContent = translation;
                    } else {
                        element.textContent = translation;
                    }
                } catch (err) {
                    console.warn(`Translation error for key "${key}":`, err);
                }
            });
        }

        // Add debouncing utility
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        // Debounced version of applyFilters
        const debouncedApplyFilters = debounce(applyFilters, 300);

        // Add event listeners to all filter inputs
        const filterInputs = document.querySelectorAll('input[type="number"], input[type="date"], select');
        filterInputs.forEach(input => {
            input.addEventListener('input', debouncedApplyFilters);
            input.addEventListener('change', debouncedApplyFilters);
        });

        let filterTimeout;
        const DEBOUNCE_DELAY = 300; // ms

        // Pagination variables
        let currentPage = 1;
        let isLoading = false;
        let hasMore = true;
        const limit = 20;

        // Current filter state
        let currentFilters = {
            priceOrder: '',
            selectedCountries: [],
            dateOrder: '',
            subCategory: '',
            selectedCarBrands: [],
            selectedCities: [],
            yearRange: { from: null, to: null },
            mileageRange: { from: null, to: null },
            fuelTypes: [],
            transmissionTypes: [],
            propertyTypes: [],
            sizeRange: { from: null, to: null },
            roomsRange: { from: null, to: null },
            bathroomsRange: { from: null, to: null },
            energyClasses: [],
            employmentTypes: [],
            salaryRange: { from: null, to: null },
            applicationDeadline: null
        };

        // Store event listeners for cleanup
        const eventListeners = new Set();

        // Function to safely add event listeners
        const addSafeEventListener = (element, event, handler) => {
            element.addEventListener(event, handler);
            eventListeners.add({ element, event, handler });
        };

        // Cleanup function
        function cleanup() {
            // Remove all stored event listeners
            eventListeners.forEach(({ element, event, handler }) => {
                element.removeEventListener(event, handler);
            });
            eventListeners.clear();

            // Cleanup lazy loader
            if (window.lazyLoader && window.lazyLoader.observer) {
                window.lazyLoader.observer.disconnect();
            }

            // Cleanup skeleton loader
            if (window.skeletonLoader) {
                window.skeletonLoader = null;
            }

            // Cleanup toast container
            const toastContainer = document.getElementById('toast-container');
            if (toastContainer) {
                toastContainer.innerHTML = '';
            }
        }

        // Add cleanup on page unload
        window.addEventListener('beforeunload', cleanup);

        // Update existing event listeners to use safe version
        const backToTopButton = document.getElementById('backToTop');
        if (backToTopButton) {
            const handleScroll = () => {
                if (window.scrollY > 300) {
                    backToTopButton.classList.add('visible');
                } else {
                    backToTopButton.classList.remove('visible');
                }
            };
            addSafeEventListener(window, 'scroll', handleScroll);
            addSafeEventListener(backToTopButton, 'click', () => {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }

        // Initialize filters and UI once
        initializeFilters();
        handleCategoryVisibility();

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function displayProducts(products, loadMore = false) {
            const container = document.getElementById('productsContainer');
            if (!loadMore) {
                container.innerHTML = '';
            }

            if (!products || products.length === 0) {
                if (!loadMore) {
                    container.innerHTML = '<p class="no-products">No products found</p>';
                }
                return;
            }

            products.forEach(product => {
                const productElement = createProductElement(product);
                container.appendChild(productElement);
            });
        }

        function createProductElement(product) {
            const isJob = product.category === 'Jobb';
            const isCar = product.category === 'Bil';
            const isProperty = product.category === 'Eiendom';

            const div = document.createElement('div');
            div.className = 'product';
            div.setAttribute('role', 'article');
            div.setAttribute('aria-label', isJob ? product.JobTitle : 
                isCar ? `${product.brand_name} ${product.model_name}` : 
                product.ProductName);
            div.setAttribute('tabindex', '0');

            // Handle images
            const images = product.Images ? product.Images.split(',') : [];
            const firstImage = images.length > 0 ? images[0].trim() : null;
            const imageUrl = firstImage ? `/uploads/${firstImage}` : '/images/default-product.png';

            div.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${isJob ? product.JobTitle : 
                        isCar ? `${product.brand_name} ${product.model_name}` : 
                        product.ProductName}" 
                     class="product-image" 
                     onerror="this.src='/images/default-product.png'"
                     loading="lazy"
                     aria-hidden="true">
                <div>
                    <h3>
                        ${isJob ? product.JobTitle || 'No title' : 
                        isCar ? 
                            `${product.brand_name || 'Unknown brand'} ${product.model_name || ''}`.trim() : 
                            product.ProductName || 'Unnamed product'}
                        ${product.Sold ? `<span class="sold-label" data-i18n="product_details.sold">(Sold)</span>` : ''}
                        <button class="favorite-icon fas fa-heart" 
                                data-product-id="${product.ProductdID}"
                                aria-label="${product.isFavorited ? 'Remove from favorites' : 'Add to favorites'}"
                                aria-pressed="${product.isFavorited ? 'true' : 'false'}">
                        </button>
                    </h3>
                    ${isCar ? `<p class="custom-title">${product.ProductName}</p>` : ''}
                    ${isJob ? `
                        <p><strong data-i18n="form.company_name">Company:</strong> ${product.CompanyName || 'Not specified'}</p>
                        <p><strong data-i18n="form.employment_type">Employment Type:</strong> ${product.EmploymentType || 'Not specified'}</p>
                    ` : ''}
                    ${isCar ? `
                        <p><strong data-i18n="form.year">Year:</strong> ${product.Year || 'N/A'}</p>
                        <p><strong data-i18n="form.mileage">Mileage:</strong> ${product.Mileage ? `${product.Mileage} km` : 'N/A'}</p>
                        <p><strong data-i18n="form.fuel_type">Fuel Type:</strong> ${product.FuelType || 'Not specified'}</p>
                    ` : ''}
                    ${isProperty ? `
                        <p><strong data-i18n="form.price">Price:</strong> ${product.Price ? `${product.Price.toLocaleString('no-NO')} kr` : i18next.t('form.price_on_request')}</p>
                        <p><strong data-i18n="form.property_type">Type:</strong> ${product.PropertyType}</p>
                        <p><strong data-i18n="property.size">Size:</strong> ${product.SizeSqm} m²</p>
                    ` : ''}
                    <p><strong data-i18n="form.location">Location:</strong> ${ 
                        (product.cityName || product.Location || i18next.t('form.not_specified')) + 
                        (product.country ? `, ${product.country}` : '')
                    }</p>
                    ${!isJob && !isCar && !isProperty ? `<p><strong data-i18n="form.price">Price:</strong> ${product.Price ? `${product.Price.toLocaleString('no-NO')} kr` : i18next.t('form.contact_for_price')}</p>` : ''}
                </div>
            `;

            // Add keyboard navigation
            div.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    window.location.href = `/productDetails?productdID=${product.ProductdID}`;
                }
            });

            // Add click event for the entire product
            div.addEventListener('click', (e) => {
                if (!e.target.classList.contains('favorite-icon')) {
                    window.location.href = `/productDetails?productdID=${product.ProductdID}`;
                }
            });

            // Add click event for the favorite icon
            const favoriteIcon = div.querySelector('.favorite-icon');
            if (favoriteIcon) {
                favoriteIcon.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const productdID = e.target.getAttribute('data-product-id');
                    const isFavorited = e.target.classList.contains('favorited');

                    try {
                        const response = await fetch('/api/favorites', {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ productdID }),
                        });

                        if (response.ok) {
                            e.target.classList.toggle('favorited');
                            e.target.style.color = isFavorited ? '#ccc' : '#ff4757';
                            window.toast.show(
                                isFavorited ? 'Product removed from favorites' : 'Product added to favorites',
                                'success'
                            );
                        } else {
                            window.toast.show('Failed to update favorites', 'error');
                        }
                    } catch (error) {
                        console.error("Error handling favorite:", error);
                        window.toast.show('An error occurred', 'error');
                    }
                });
            }

            return div;
        }

        function fetchProducts(loadMore = false, cacheBuster = null) {
            if (isLoading || (!loadMore && !hasMore)) return;
            
            showLoading();
            isLoading = true;

            if (!loadMore) {
                showSkeletonLoading();
            }

            // Calculate the page and offset
            const newPage = loadMore ? currentPage + 1 : 1;
            const offset = (newPage - 1) * limit;

            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category') || 'default';


            // Build API URL with current filters
            let apiUrl = `/api/products?category=${category}&limit=${limit}&offset=${offset}`;
            if (cacheBuster) {
                apiUrl += `&_=${cacheBuster}`;
            }
            if (currentFilters.subCategory) apiUrl += `&subCategory=${currentFilters.subCategory}`;
            if (currentFilters.priceOrder) apiUrl += `&sortPrice=${currentFilters.priceOrder}`;
            if (currentFilters.dateOrder) apiUrl += `&sortDate=${currentFilters.dateOrder}`;
            if (currentFilters.selectedCarBrands.length) apiUrl += `&carBrand=${currentFilters.selectedCarBrands.join(',')}`;
            if (currentFilters.selectedCountries.length) {
              apiUrl += `&countries=${encodeURIComponent(currentFilters.selectedCountries.join(','))}`;
            }
            if (currentFilters.selectedCities.length) {
              apiUrl += `&cities=${currentFilters.selectedCities.join(',')}`;
            }

            // Add car specific filters
            if (category === 'Bil') {
                if (currentFilters.yearRange.from) {
                    apiUrl += `&yearFrom=${currentFilters.yearRange.from}`;
                }
                if (currentFilters.yearRange.to) {
                    apiUrl += `&yearTo=${currentFilters.yearRange.to}`;
                }
                if (currentFilters.mileageRange.from) {
                    apiUrl += `&mileageFrom=${currentFilters.mileageRange.from}`;
                }
                if (currentFilters.mileageRange.to) {
                    apiUrl += `&mileageTo=${currentFilters.mileageRange.to}`;
                }
                if (currentFilters.fuelTypes.length) {
                    apiUrl += `&fuelTypes=${currentFilters.fuelTypes.join(',')}`;
                }
                if (currentFilters.transmissionTypes.length) {
                    apiUrl += `&transmissionTypes=${currentFilters.transmissionTypes.join(',')}`;
                }
            }

            // Add property specific filters
            if (category === 'Eiendom') {
                if (currentFilters.propertyTypes.length) {
                    apiUrl += `&propertyType=${encodeURIComponent(currentFilters.propertyTypes.join(','))}`;
                }
                if (currentFilters.sizeRange.from) {
                    apiUrl += `&sizeSqmFrom=${encodeURIComponent(currentFilters.sizeRange.from)}`;
                }
                if (currentFilters.sizeRange.to) {
                    apiUrl += `&sizeSqmTo=${encodeURIComponent(currentFilters.sizeRange.to)}`;
                }
                if (currentFilters.roomsRange.from) {
                    apiUrl += `&numRoomsFrom=${encodeURIComponent(currentFilters.roomsRange.from)}`;
                }
                if (currentFilters.roomsRange.to) {
                    apiUrl += `&numRoomsTo=${encodeURIComponent(currentFilters.roomsRange.to)}`;
                }
                if (currentFilters.bathroomsRange.from) {
                    apiUrl += `&numBathroomsFrom=${encodeURIComponent(currentFilters.bathroomsRange.from)}`;
                }
                if (currentFilters.bathroomsRange.to) {
                    apiUrl += `&numBathroomsTo=${encodeURIComponent(currentFilters.bathroomsRange.to)}`;
                }
                if (currentFilters.energyClasses.length) {
                    apiUrl += `&energyClass=${encodeURIComponent(currentFilters.energyClasses.join(','))}`;
                }
            }

            // Add work specific filters
            if (category === 'Jobb') {
                if (currentFilters.employmentTypes.length) {
                    apiUrl += `&employmentTypes=${currentFilters.employmentTypes.join(',')}`;
                }
                if (currentFilters.salaryRange.from) {
                    apiUrl += `&salaryFrom=${currentFilters.salaryRange.from}`;
                }
                if (currentFilters.salaryRange.to) {
                    apiUrl += `&salaryTo=${currentFilters.salaryRange.to}`;
                }
                if (currentFilters.applicationDeadline) {
                    apiUrl += `&deadline=${currentFilters.applicationDeadline}`;
                }
            }

            // Show loading state
            const container = document.getElementById('productsContainer');
            const loadButton = document.getElementById('loadMoreButton');
            if (!loadMore) container.innerHTML = '<p>Loading products...</p>';
            if (loadButton) {
                loadButton.disabled = true;
                loadButton.textContent = 'Loading...';
            }

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                     hasMore = (currentPage * limit) < data.total;
                     displayProducts(data.products, loadMore);

                     // Reposition the load more button to the bottom of the container
                     const loadButton = document.getElementById('loadMoreButton');
                     if (loadButton) {
                         const buttonWrapper = loadButton.parentElement;
                         document.getElementById('productsContainer').appendChild(buttonWrapper);
                     }

                     // Update currentPage after successful fetch
                    currentPage = newPage;
                    isLoading = false;

                    // Initialize lazy loading for new images
                    if (window.lazyLoader) window.lazyLoader.observe();

                    // Update load more button visibility and state
                    if (document.getElementById('loadMoreButton')) {
                     document.getElementById('loadMoreButton').style.display = hasMore ? 'block' : 'none';
                     document.getElementById('loadMoreButton').disabled = false;
                     document.getElementById('loadMoreButton').textContent = 'Load More';
                 } else {
                     addLoadMoreButton();
                 }
            })
                .catch(error => {
                    console.error("Error fetching products:", error);
                    isLoading = false;
                    const container = document.getElementById('productsContainer');
                    container.innerHTML = `
                        <div class="error-message">
                            <p>Error loading products. Please try again.</p>
                            <button onclick="fetchProducts()" class="retry-button">Retry</button>
                        </div>
                    `;
                    window.toast.show('Error loading products. Please try again.', 'error');
                })
                .finally(() => {
                    hideLoading();
                });
        }

        function resetFilters() {  
            // 1. Reset UI elements
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            // 2. Hide city lists instead of clearing them
            document.querySelectorAll('.city-list').forEach(list => {
                list.style.display = 'none'; 
            });
            
            // Reset dropdowns
            document.getElementById('priceFilter').value = 'asc';
            document.getElementById('dateFilter').value = '';

            // Reset category-specific filters
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category') || 'default';

            // Reset Torget filters
            if (category === 'Torget') {
                document.getElementById('subCategoryFilter').value = '';
            }

            // Reset Car filters
            if (category === 'Bil') {
                document.getElementById('yearFrom').value = '';
                document.getElementById('yearTo').value = '';
                document.getElementById('mileageFrom').value = '';
                document.getElementById('mileageTo').value = '';
                document.getElementById('fuelTypeFilter').selectedIndex = -1;
                document.getElementById('transmissionFilter').selectedIndex = -1;
            }

            // Reset Property filters
            if (category === 'Eiendom') {
                document.getElementById('propertyTypeFilter').selectedIndex = -1;
                document.getElementById('sizeFrom').value = '';
                document.getElementById('sizeTo').value = '';
                document.getElementById('roomsFrom').value = '';
                document.getElementById('roomsTo').value = '';
                document.getElementById('bathroomsFrom').value = '';
                document.getElementById('bathroomsTo').value = '';
                document.getElementById('energyClassFilter').selectedIndex = -1;
            }

            // Reset Work filters
            if (category === 'Jobb') {
                document.getElementById('employmentTypeFilter').selectedIndex = -1;
                document.getElementById('salaryFrom').value = '';
                document.getElementById('salaryTo').value = '';
                document.getElementById('deadlineDate').value = '';
            }

            // 3. Reset internal state
            currentFilters = {
                priceOrder: 'asc',
                dateOrder: '',
                subCategory: '',
                selectedCountries: [],
                selectedCarBrands: [],
                selectedCities: [],
                yearRange: { from: null, to: null },
                mileageRange: { from: null, to: null },
                fuelTypes: [],
                transmissionTypes: [],
                propertyTypes: [],
                sizeRange: { from: null, to: null },
                roomsRange: { from: null, to: null },
                bathroomsRange: { from: null, to: null },
                energyClasses: [],
                employmentTypes: [],
                salaryRange: { from: null, to: null },
                applicationDeadline: null
            };

            // 4. Reset pagination
            currentPage = 1;
            hasMore = true;
            isLoading = false; 

            // 5. Clear container and force fresh load
            const container = document.getElementById('productsContainer');
            container.innerHTML = '<p>Loading products...</p>';
            
            // 6. Fetch with cache busting
            fetchProducts(false, Date.now());
        }

        window.resetFilters = resetFilters;
        window.fetchProducts = fetchProducts;

        function addLoadMoreButton() {
            const existingButton = document.getElementById('loadMoreButton');
            if (existingButton) return;

            const button = document.createElement('button');
            button.id = 'loadMoreButton';
            button.className = 'load-more-btn';
            button.textContent = 'Load More';
            button.style.display = hasMore ? 'block' : 'none';
             button.addEventListener('click', () => {
                fetchProducts(true);
            });
            
            const container = document.getElementById('productsContainer');
            const buttonWrapper = document.createElement('div');
            buttonWrapper.style.textAlign = 'center';
            buttonWrapper.style.width = '100%';
            buttonWrapper.appendChild(button);
            container.appendChild(buttonWrapper);
        }

        function applyFilters() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                // Get values from car filters
                const yearFrom = document.getElementById('yearFrom')?.value;
                const yearTo = document.getElementById('yearTo')?.value;
                const mileageFrom = document.getElementById('mileageFrom')?.value;
                const mileageTo = document.getElementById('mileageTo')?.value;
                const fuelTypeSelect = document.getElementById('fuelTypeFilter');
                const transmissionSelect = document.getElementById('transmissionFilter');

                // Get values from property filters
                const propertyTypeSelect = document.getElementById('propertyTypeFilter');
                const sizeFrom = document.getElementById('sizeFrom')?.value;
                const sizeTo = document.getElementById('sizeTo')?.value;
                const roomsFrom = document.getElementById('roomsFrom')?.value;
                const roomsTo = document.getElementById('roomsTo')?.value;
                const bathroomsFrom = document.getElementById('bathroomsFrom')?.value;
                const bathroomsTo = document.getElementById('bathroomsTo')?.value;
                const energyClassSelect = document.getElementById('energyClassFilter');

                // Get values from work filters
                const employmentTypeSelect = document.getElementById('employmentTypeFilter');
                const salaryFrom = document.getElementById('salaryFrom')?.value;
                const salaryTo = document.getElementById('salaryTo')?.value;
                const deadlineDate = document.getElementById('deadlineDate')?.value;

                currentFilters = {
                    priceOrder: document.getElementById('priceFilter').value,
                    dateOrder: document.getElementById('dateFilter').value,
                    subCategory: document.getElementById('subCategoryFilter')?.value || '',
                    selectedCountries: Array.from(
                        document.querySelectorAll('.country-list input[type="checkbox"]:checked')
                    ).map(checkbox => checkbox.value),
                    selectedCities: Array.from(
                        document.querySelectorAll('.city-list input[type="checkbox"]:checked')
                    ).map(checkbox => checkbox.value),
                    selectedCarBrands: Array.from(
                        document.querySelectorAll('.car-brand-list input[type="checkbox"]:checked')
                    ).map(checkbox => checkbox.value),
                    yearRange: {
                        from: yearFrom || null,
                        to: yearTo || null
                    },
                    mileageRange: {
                        from: mileageFrom || null,
                        to: mileageTo || null
                    },
                    fuelTypes: Array.from(fuelTypeSelect?.selectedOptions || []).map(option => option.value),
                    transmissionTypes: Array.from(transmissionSelect?.selectedOptions || []).map(option => option.value),
                    propertyTypes: Array.from(propertyTypeSelect?.selectedOptions || []).map(option => option.value),
                    sizeRange: {
                        from: sizeFrom || null,
                        to: sizeTo || null
                    },
                    roomsRange: {
                        from: roomsFrom || null,
                        to: roomsTo || null
                    },
                    bathroomsRange: {
                        from: bathroomsFrom || null,
                        to: bathroomsTo || null
                    },
                    energyClasses: Array.from(energyClassSelect?.selectedOptions || []).map(option => option.value),
                    employmentTypes: Array.from(employmentTypeSelect?.selectedOptions || []).map(option => option.value),
                    salaryRange: {
                        from: salaryFrom || null,
                        to: salaryTo || null
                    },
                    applicationDeadline: deadlineDate || null
                };

                // Force reset pagination
                currentPage = 1;
                hasMore = true;
                document.getElementById('productsContainer').innerHTML = '<p>Loading products...</p>';
                fetchProducts();
            }, DEBOUNCE_DELAY);
        }

        document.getElementById('dateFilter').addEventListener('change', () => {
        document.getElementById('priceFilter').value = '';
        applyFilters();
    });
        document.getElementById('priceFilter').addEventListener('change', () => {
        document.getElementById('dateFilter').value = '';
        applyFilters();
    });

    function handleCategoryVisibility() {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category') || 'default';
        const subcategoryContainer = document.getElementById('subcategoryFilterContainer');
        const carBrandSection = document.getElementById('carBrandList');
        const carBrandLabel = document.getElementById('filterCar');
        const carSpecificFilters = document.getElementById('carSpecificFilters');
        const propertySpecificFilters = document.getElementById('propertySpecificFilters');
        const workSpecificFilters = document.getElementById('workSpecificFilters');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');

        // Toggle subcategory filter
        if (subcategoryContainer) {
            subcategoryContainer.style.display = category === 'Torget' ? 'block' : 'none';
        }

        // Toggle car brand filter and specific filters
        if (carBrandSection && carBrandLabel && carSpecificFilters) {
            const shouldShowCar = category === 'Bil';
            carBrandSection.style.display = shouldShowCar ? 'block' : 'none';
            carBrandLabel.style.display = shouldShowCar ? 'block' : 'none';
            carSpecificFilters.style.display = shouldShowCar ? 'block' : 'none';
        }

        // Toggle property specific filters
        if (propertySpecificFilters) {
            propertySpecificFilters.style.display = category === 'Eiendom' ? 'block' : 'none';
        }

        // Toggle work specific filters
        if (workSpecificFilters) {
            workSpecificFilters.style.display = category === 'Jobb' ? 'block' : 'none';
        }

        // Show reset filters button for all valid categories
        if (resetFiltersBtn) {
            resetFiltersBtn.style.display = ['Torget', 'Bil', 'Jobb', 'Eiendom'].includes(category) ? 'flex' : 'none';
        }
    }

        function initializeFilters() {
            // Add a flag to track if filters have been initialized
            if (window.filtersInitialized) {
                console.log("Filters already initialized, skipping...");
                return;
            }
            window.filtersInitialized = true;

            console.log("Initializing filters...");

            // Price and Date filters
            document.getElementById('priceFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            
            // Subcategory filter
            const subCategoryFilter = document.getElementById('subCategoryFilter');
            if (subCategoryFilter) {
                subCategoryFilter.addEventListener('change', applyFilters);
            }

            // Add event listeners for work filters
            ['salaryFrom', 'salaryTo'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                    element.addEventListener('input', function() {
                        if (this.value.length > 10) {
                            this.value = this.value.slice(0, 10);
                        }
                    });
                }
            });

            const deadlineDate = document.getElementById('deadlineDate');
            if (deadlineDate) {
                deadlineDate.addEventListener('change', applyFilters);
                const today = new Date().toISOString().split('T')[0];
                deadlineDate.min = today;
            }

            // Add event listeners for all filter elements
            ['employmentTypeFilter', 'propertyTypeFilter', 'energyClassFilter', 'fuelTypeFilter', 'transmissionFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });

            // Add event listeners for numeric inputs
            ['sizeFrom', 'sizeTo', 'roomsFrom', 'roomsTo', 'bathroomsFrom', 'bathroomsTo', 'yearFrom', 'yearTo', 'mileageFrom', 'mileageTo'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', applyFilters);
                    element.addEventListener('change', applyFilters);
                    element.addEventListener('input', function() {
                        if (this.value.length > 7) {
                            this.value = this.value.slice(0, 7);
                        }
                    });
                }
            });

            // Initialize countries and cities
            initializeCountries();
            
            // Initialize car brands
            initializeCarBrands();
        }

        function initializeCountries() {
            const countryList = document.querySelector('.country-list');
            if (!countryList || countryList.children.length > 0) return;

            fetch('/api/utils/countries')
                .then(response => response.json())
                .then(countries => {
                    countries.forEach(countryData => {
                        const countryItem = document.createElement('li');
                        countryItem.innerHTML = `
                            <div>
                                <input type="checkbox" id="${countryData.country}" value="${countryData.country}">
                                <label for="${countryData.country}">${countryData.country}</label>
                            </div>
                            <ul class="city-list" id="${countryData.country}-cities" style="display: none;"></ul>
                        `;
                        
                        const cityList = countryItem.querySelector('.city-list');
                        countryData.cities = countryData.cities || []; // Ensure it's an array
                        const cities = Array.isArray(countryData.cities) ? countryData.cities : [];
                        const cityIds = Array.isArray(countryData.city_ids) ? countryData.city_ids : [];

                        cities.forEach((cityName, index) => {
                            const cityId = cityIds[index] || `unknown_${index}`; // Handle missing IDs
                            cityList.innerHTML += `
                                <li>
                                    <input type="checkbox" id="city_${cityId}" value="${cityId}">
                                    <label for="city_${cityId}">${cityName}</label>
                                </li>
                            `;
                        });

                        const countryCheckbox = countryItem.querySelector('input[type="checkbox"]');
                        countryCheckbox.addEventListener('change', function() {
                            const cityList = countryItem.querySelector('.city-list');
                            const cityCheckboxes = cityList.querySelectorAll('input[type="checkbox"]');
                            if (!this.checked) {
                                cityCheckboxes.forEach(cityCB => cityCB.checked = false);
                            }
                            cityList.style.display = this.checked ? 'block' : 'none';
                            applyFilters();
                        });

                        countryList.appendChild(countryItem);
                    });

                    document.querySelectorAll('.city-list input').forEach(cityCheckbox => {
                        cityCheckbox.addEventListener('change', applyFilters);
                    });
                })
                .catch(error => {
                    console.error("Error loading countries and cities:", error);
                    countryList.innerHTML = '<p>Error loading countries</p>';
                });
        }

        function initializeCarBrands() {
            const container = document.getElementById('carBrandList');
            if (!container || container.children.length > 0) return;

            fetch('/api/utils/car-brands')
                .then(response => response.json())
                .then(brands => {
                    if (!brands || brands.length === 0) {
                        console.log("No car brands received");
                        return;
                    }

                    console.log("Loading car brands:", brands.length);
                    brands.forEach(brand => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <input type="checkbox" id="brand_${brand.brand_id}" value="${brand.brand_id}">
                                <label for="brand_${brand.brand_id}">${brand.brand_name}</label>
                            </div>
                        `;
                        container.appendChild(li);

                        const checkbox = li.querySelector('input[type="checkbox"]');
                        checkbox.addEventListener('change', applyFilters);
                    });
                })
                .catch(error => {
                    console.error("Error loading car brands:", error);
                    container.innerHTML = '<p>Error loading car brands</p>';
                });
        }

        function initializeFavorites() {
            fetch('/api/favorites')
                .then(response => response.json())
                .then(favorites => {
                    document.querySelectorAll('.favorite-icon').forEach(icon => {
                        const productdID = icon.getAttribute('data-product-id');
                        const isFavorited = favorites.some(product => product.ProductdID === Number(productdID));
                        icon.classList.toggle('favorited', isFavorited);
                        icon.style.color = isFavorited ? '#ff4757' : '#ccc';
                    });
                })
                .catch(error => console.error("Error checking favorites:", error));
        }

        function showSkeletonLoading() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const skeleton = document.createElement('div');
                skeleton.className = 'product skeleton';
                skeleton.innerHTML = `
                    <div class="skeleton-image skeleton"></div>
                    <div>
                        <div class="skeleton-text skeleton-title skeleton"></div>
                        <div class="skeleton-text skeleton-price skeleton"></div>
                        <div class="skeleton-text skeleton-location skeleton"></div>
                    </div>
                `;
                container.appendChild(skeleton);
            }
        }

        window.onload = function () {
            fetchProducts();
            checkUnreadMessages();
            initializeFilters();
            initializeFavorites();
            applyFilters();
            handleCategoryVisibility();
            checkUnreadMessages();
            
            // Initialize lazy loading
            if (window.lazyLoader) {
                window.lazyLoader.observe();
            }
        };
    });
</script>
</body>
</html>